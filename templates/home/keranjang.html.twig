{% extends 'layout.html.twig' %}

{% block title %}Keranjang{% endblock %}

{% block body %}
{# begin:: background #}
<section class="hero-wrap hero-wrap-2" style="background-image: url('{{ asset('assets/user/images/tahu.jpg') }}');" data-stellar-background-ratio="0.5">
    <div class="overlay"></div>
    <div class="container">
        <div class="row no-gutters slider-text align-items-end justify-content-center">
            <div class="col-md-9 ftco-animate mb-5 text-center">
                <h2 class="mb-0 bread">Keranjang</h2>
            </div>
        </div>
    </div>
</section>
{# end:: background #}

<section class="ftco-section">
    <div class="container">
        <form action="/user/checkout" method="post">
            <div class="row">
                <div class="table-wrap">
                    <table class="table">
                        <thead class="thead-primary">
                            <tr>
                                <th>No.</th>
                                <th>Gambar</th>
                                <th>Nama</th>
                                <th>Jumlah</th>
                                <th>Harga</th>
                                <th>Sub Total</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set sum = 0 %}
                            {% for rows in keranjang %}
                            {% set sum = sum + rows.sub_total  %}
                            {% set stock_terjual = (rows.stock - rows.jumlah) %}
                            {% set stock = stock_terjual %}
                            <tr class="alert" role="alert">
						    	<td>{{ loop.index }} </td>
						    	<td>
						    		<img src="{{ asset('uploads/produk/'~rows.gambar) }}" width="100" heigth="100" />
						    	</td>
						    	<td>
                                    <div class="email">
						    			<span>{{ rows.nama }}</span>
						    		</div>
                                    <input type="hidden" name="inpidkeranjang[]" id="inpidkeranjang" value="{{ rows.id_keranjang }}" />
						    	</td>
						    	<td>
						    		<div class="input-group">
                                        <input type="text" class="form-control" onkeydown="return justAngka(event)" name="inpjumlah[]" id="inpjumlah" data-stock="{{ stock }}" value="{{ rows.jumlah_keranjang }}" />
						    		</div>
						    	</td>
						    	<td>
                                    {{ rows.harga|format_rp }}
                                    <input type="hidden" name="inpharga[]" id="inpharga" value="{{ rows.harga }}" />
                                </td>
						    	<td>
                                    <span id="sub-total">{{ rows.sub_total|format_rp }}</span>
                                    <input type="hidden" name="inpsubtotal[]" id="inpsubtotal" value="{{ rows.sub_total }}" />
                                </td>
						    	<td>
                                    <button type="button" id="del" data-id="{{ rows.id_keranjang }}" class="close">
                                        <span aria-hidden="true"><i class="fa fa-close"></i></span>
                                    </button>
						    	</td>
						    </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row justify-content-end">
                <div class="col col-lg-5 col-md-6 mt-5 cart-wrap ftco-animate">
                    <div class="cart-total mb-3">
                        <h3>Cart Totals</h3>
                        <p class="d-flex total-price">
                            <span>Total</span>
                            <span id="total">{{ sum|format_rp }}</span>
                        </p>
                    </div>
                    <p class="text-center"><a href="/produk" class="btn btn-primary py-3 px-4">Lanjut Belanja</a></p>
                    <button type="submit" class="btn btn-primary py-3 px-4">Checkout</button>
                </div>
            </div>
        </form>
    </div>
</section>
{% endblock %}

{% block javascripts %}
<script>
    // untuk ubah jumlah
    var untukUbahJumlah = function () {
        $('body').on('input', '#inpjumlah', function () {
            var txt1 = $(this).val();
            var txt2 = $(this).parent().parent().parent().find('#inpharga').val();
            var stock = $(this).data('stock');

            // untuk membatasi value stock
            if (txt1 >= stock) {
                $(this).val(Math.max(Math.min(txt1, stock), -stock));
                txt1 = stock;
            } else {
                txt1 = txt1;
            }

            var total = $('[id="inpsubtotal"]');
            var jumlah = parseInt(txt1) * parseInt(txt2);

            if (txt1 == 0 || isNaN(jumlah)) {
                $(this).parent().parent().parent().find('#sub-total').html('0')
                $(this).parent().parent().parent().find('#inpsubtotal').val('0')
            } else {
                $(this).parent().parent().parent().find('#sub-total').html(autoSeparator(jumlah))
                $(this).parent().parent().parent().find('#inpsubtotal').val(jumlah)
            }

            var totalSum = [];
            for (let i = 0; i < total.length; i++) {
                totalSum.push(parseInt($(total[i]).val()));
            }

            var sum = totalSum.reduce(function (a, b) {
                return a + b;
            }, 0);

            $('#total').html(autoSeparator(sum));
        });
    }();

    // untuk hapus data
    var untukHapusData = function() {
        $(document).on('click', '#del', function() {
            var ini = $(this);

            if (confirm("Apakah Anda yakin ingin menghapusnya?")) {
                $.ajax({
                    type: "post",
                    url: "keranjang/del",
                    dataType: 'json',
                    data: {
                        id: ini.data('id')
                    },
                    beforeSend: function() {
                        ini.attr('disabled', 'disabled');
                        ini.html('<i class="fa fa-spinner"></i>');
                    },
                    success: function(data) {
                        alert(data.msg);
                        location.reload();
                    }
                });
            } else {
                return false;
            }
        });
    }();

    // untuk angka
	function justAngka(e) {
		if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190, 77]) !== -1 ||
			(e.keyCode === 65 && (e.ctrlKey === true || e.metaKey === true)) ||
			(e.keyCode >= 35 && e.keyCode <= 40)) {
			return;
		}
		if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
			e.preventDefault();
		}
	};

    // untuk format harga
	function autoSeparator(Num) {
		Num += '';
		Num = Num.replace('.', '');
		Num = Num.replace('.', '');
		Num = Num.replace('.', '');
		Num = Num.replace('.', '');
		Num = Num.replace('.', '');
		Num = Num.replace('.', '');
		x = Num.split('.');
		x1 = x[0];
		x2 = x.length > 1 ? '.' + x[1] : '';
		var rgx = /(\d+)(\d{3})/;
		while (rgx.test(x1))
			x1 = x1.replace(rgx, '$1' + '.' + '$2');
		return x1 + x2;
	};
</script>
{% endblock %}